<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
    
    <!-- Hidden input element for file selection -->
    <div class="load-file-div">        
        <button id="loadFileToggle" class="collapsed">+</button>
        <div class="content">                
            <!-- Button to trigger the file dialog -->
            <button class="file-button" onclick="myFileDialog.open()"><i class="fa fa-file"></i></button>

            <!-- Text area to display file contents -->
            <textarea id="fileContents" rows="10" cols="50"></textarea><input type="file" id="fileDialog" style="display: none">
        </div> 
    </div>

    <!-- Container for displaying div panels -->
    <div id="tileOutputContainer"></div>
    
    <script>
        
        /*
         *************************************************************************************************************
         ************************************************************************************************************** 
         * README - Where to begin?
         * #1 - Inits via FileDialog/myFileDialog's filepicker .onload calling the internal readFile (of myFileDialog)
         * #2 - readFile calls the TileOutput's internal read function
         * #3 - TileOutput's internal read processes each individual line in the file
         * #4   - Sets identation level and calls TileOutput's append to add "Tile" element to dom
         **************************************************************************************************************
         **************************************************************************************************************
        */        
        
        const FileToggle = CreateToggleButton('loadFileToggle');
        const myFileDialog =  new FileDialog('fileDialog');
        const tileOutput = new TileOutput();
        const isValidUrl = urlString=> {
            try { 
                return new URL(urlString); 
            }
            catch(e){ 
                return null; 
            }
        }
        function FileDialog(id) {      
                        
            this.element = document.getElementById(id);
            this.element.addEventListener('change', 
                (event) => {                     
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) { 
                            var contents = e.target.result;
                            // Display file contents in the text area
                            document.getElementById('fileContents').value = contents;
                            myFileDialog.readFile(contents);                                      
                        };
                        reader.readAsText(file);

                        FileToggle.classList.remove('collapsed');
                        FileToggle.nextElementSibling.classList.add('collapsed');
                    }                    
                });

            this.open = function() {
                this.element.click();
            }

            this.readFile = function(fileContents) {                
                // Process each line and create div panels
                const lines = fileContents.split('\n');                    
                tileOutput.element.innerHTML = ''; // Clear existing content
                tileOutput.read(lines);                                     
            }
        }
        function TileOutput(){
            this.element = document.getElementById('tileOutputContainer');
            var coords = { holdingX: 0, holdingY: 65};
            var extractAnyUrl = (inputString) => {                
                const lastOpenParenIndex = inputString.lastIndexOf('(');
                if (lastOpenParenIndex === -1) {
                    // No open parenthesis found
                    return null;
                }
                const matchingCloseParenIndex = inputString.indexOf(')', lastOpenParenIndex);
                if (matchingCloseParenIndex === -1) {
                    // No matching closing parenthesis found
                    return null;
                }
                // Extract the content between the parentheses
                const extractedContent = inputString.slice(lastOpenParenIndex + 1, matchingCloseParenIndex);
                return isValidUrl(extractedContent);
            } 
            var createLabel = (textContent) => {
                var validURLIfSet = extractAnyUrl(textContent);                
                if (validURLIfSet){                                       
                    ele = document.createElement('a');
                    ele.setAttribute("href", validURLIfSet.toString());
                    ele.textContent = textContent.slice(0, textContent.lastIndexOf('('));
                    
                    ele.target = '_blank';
                }
                else {
                    ele = document.createTextNode(textContent);
                }
                return ele;
            }   
            var stack = [];
            this.read = (lines) => {
                stack[stack.length] = { element: this.element, level: 0 };
                stack[stack.length] = stack[stack.length - 1];
                lines.forEach((line, index) => {
                    var trimmedLine = line.trimLeft(); // Remove leading spaces
                    const indentationLevel = (line.length - trimmedLine.length) / 2;
                    trimmedLine = trimmedLine.replace("- [ ] ", ""); 
                    if (trimmedLine.length > 0){                                                           
                        append(
                            new Tile(
                                createLabel(trimmedLine), 
                                indentationLevel));
                    }
                }); 
            }
            var append = (tile) => {
                tile.setPosition(coords);                
                doUpALevel(tile.level);
                doDownALevel(tile.level);                
                stack[stack.length - 1] = tile;
                stack[stack.length - 2].element.appendChild(tile.element);
            }
            var doUpALevel = (indentationLevel) => {
                var parentTile = stack[stack.length - 1];
                if (parentTile.level < indentationLevel) {                    
                    stack[stack.length - 1] = { element: parentTile.addContent(), level: parentTile.level }; // Add content container to parent and overlay to stack
                    stack[stack.length] = parentTile; // Push temp parent as placeholder for sub-tile
                }                        
            } 
            var doDownALevel = (indentationLevel) => {
                while (stack[stack.length - 1].level > indentationLevel) {
                    stack.pop();
                }                
            }
        }

        function Tile(label, indentationLevel){            
            this.level = indentationLevel;
            var div = document.createElement('div');                       
            if (this.level > 0){
                div.classList.add('sub-tile'); 
            }
            else {
                div.style.height =  '500px';
                div.style.width =  '300px';                
                div.classList.add('tile');
                
                // some sub-level tasks
                var top = document.createElement('div');
                top.innerHTML = '&nbsp;';
                top.classList.add('dragging-handle');
                div.appendChild(top); 
                let isDragging = false;
                let offsetX, offsetY;
                
                top.addEventListener('mousedown', (e) => {
                    e.preventDefault();             
                    isDragging = true;                                               
                    top.style.cursor = 'grabbing';
                });
               
                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        const newX = e.clientX;
                        const newY = e.clientY;
                        div.style.left = `${newX}px`;
                        div.style.top = `${newY}px`;
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    top.style.cursor = 'grab';
                });
            }
            div.appendChild(label); 
            
            this.element = div;
            this.addContent = function () {                
                if (this.level > 0){                   
                    return div;
                }
                else {
                    div.appendChild(CreateToggleButton());  
                    const divSubPanel = document.createElement('div');
                    divSubPanel.classList.add('content');
                    divSubPanel.classList.add('collapsed');
                    div.appendChild(divSubPanel);                     
                    return divSubPanel;
                }                
            }
            this.setPosition = (coords) => {
                if (this.level == 0){
                    div.style.left = `${coords.holdingX}px`;
                    div.style.top = `${coords.holdingY}px`;
                    if ((coords.holdingX + 450) < window.innerWidth){
                        coords.holdingX += 150;
                    }
                    else {
                        coords.holdingX = 0;
                        coords.holdingY += 50;
                    }
                }
            }
        } 
        function CreateToggleButton(id) {            
            var element = null;
            if (id){
                element = document.getElementById(id);
            }            
            else {                
                element = document.createElement('button'); 
                element.textContent = '+'; 
            }                       

            element.addEventListener('click', () => {                 
                const allContentBlocks = document.querySelectorAll(".content"); 
                var isExpanding = element.textContent == '+'; 
                allContentBlocks.forEach((block) => {
                    if (!block.classList.contains('collapsed')){
                        block.previousElementSibling.textContent = '+';                         
                        block.classList.add('collapsed'); // hide content
                        block.parentElement.style.zIndex = 0;
                    }                    
                });
                if (isExpanding){                
                    element.nextElementSibling.classList.remove('collapsed');
                    element.textContent = '-';
                    element.parentElement.style.zIndex = 1;
                }

                var theZoomedItem = document.querySelector('.zoomed');                    
                if (theZoomedItem){
                    theZoomedItem.classList.remove('zoomed');  
                }

                if (isExpanding){
                    if (element.parentElement.classList.contains('tile')){                    
                        element.parentElement.classList.add('zoomed');                                    
                    }
                }                                
            });
            return element;
        }

    </script>
    <style>
        .file-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            vertical-align: top;
        }

        /* Add an icon to the button */
        .file-button i {
            margin-right: 5px;
        }

        .load-file-div{                                    
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 5px 0; 
            position: absolute;              
        }
        
        .dragging-handle {            
            background-color: black;
            cursor: grab;
            position: relative;
            clear:both;
        }

        .zoomed {
            transform: scale(1.12);
            transform-origin: top left; /* Set the desired origin */                                 
        }
          
        /* Style the collapsible content (hidden by default) */
        .content {               
            /*background-color: #f1f1f1;*/
        }

        .collapsed {
            display: none;
        }        

        .tile {
            position:absolute;
            border: 2px solid #000;
            
            background-color: #f9f9f9;
            transition: transform 0.3s ease; 
            resize: both; /* Enable resizing cursor */
            overflow: auto; /* Show scrollbars if content overflows */
        } 

        .sub-tile {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 5px 0;
            background-color: aqua;
        }         
        
    </style>
</body>
</html>